---
- name: Provision AI tools on server
  hosts: localhost

  tasks:
  - name: Create a log directory
    ansible.builtin.file:
      path: /home/ubuntu/logs
      state: directory

  - name: Add APT Repository for Python
    ansible.builtin.shell: add-apt-repository ppa:deadsnakes/ppa

  - name: Update APT
    ansible.builtin.shell: apt update

  - name: Install Python 3.12
    become: true
    apt:
      name: "{{ item }}"
      state: present
    with_items:
    - python3.12
    - python3.12-venv

  - name: Install pip for Python 3.12
    ansible.builtin.shell: "python3.12 -m ensurepip --upgrade"

  - name: Get Python 3.12 Pythonpath
    shell: "which python3.12"
    register: python_path
    changed_when: false

  - name: Create Python Virtual Environment
    shell: "{{ python_path.stdout }} -m venv /home/ubuntu/ai-venv"
    args:
      creates: "/home/ubuntu/ai-venv"

  - name: Install packages
    apt:
      pkg:
      - unzip
      - docker.io
  
  - name: Adding Python packages via pip
    pip:
      executable: "/home/ubuntu/ai-venv/bin/pip"
      name:
      - jupyterlab
      - notebook
      - ollama

  - name: Install Ollama
    ansible.builtin.shell: curl -fsSL https://ollama.com/install.sh | sh

  - name: Generate the notebook configuration
    shell: "/home/ubuntu/ai-venv/bin/jupyter notebook --generate-config -y"

  - name: Add password to Jupyter configuration
    expect:
      command: "/home/ubuntu/ai-venv/bin/jupyter notebook password"
      responses:
        Enter password: "{{ pw }}"
        Verify password: "{{ pw }}"

  - name: Create Jupyter content folder
    ansible.builtin.shell: mkdir /home/ubuntu/jupyter

  - name: Download EasyDiffusion installer
    ansible.builtin.shell: wget https://github.com/cmdr2/stable-diffusion-ui/releases/latest/download/Easy-Diffusion-Linux.zip -O /home/ubuntu/easy-diffusion.zip

  - name: Unzip EasyDiffusion installer
    ansible.builtin.shell: unzip /home/ubuntu/easy-diffusion.zip

  - name: Clean up EasyDiffusion installer ZIP
    ansible.builtin.shell: rm /home/ubuntu/easy-diffusion.zip

  - name: Start Jupyter Server
    shell: "/home/ubuntu/ai-venv/bin/jupyter lab --ServerApp.root_dir=/home/ubuntu/jupyter --no-browser --port=8090 --ip=0.0.0.0 --allow-root > /home/ubuntu/logs/jupyter.log 2>&1 &"
    async: 2

  - name: Start Open WebUI Server
    shell: "docker run -d -p 3000:8080 -v ollama:/root/.ollama -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:ollama"

  - name: Start EasyDiffusion Web UI
    shell: "sh /home/ubuntu/easy-diffusion/start.sh"
